<?xml version="1.0"?>
<robot xmlns:xacro="http://www.ros.org/wiki/xacro">

<xacro:macro name="thruster" params="prop_num vco mesh_file">
  <link name="thruster_${prop_num}">
    <inertial>
      <origin xyz="0.0 0.0 0.0" rpy="0 0 0"/>
      <mass value="0.035"/>
      <inertia ixx="0.00000146" iyy="0.000189" izz="0.000188" ixy="0.0" iyz="0.0" ixz="0.0"/>
    </inertial>
    <visual>
      <origin xyz="${vco}" rpy="0 0 0"/>
      <geometry>
        <mesh filename="file://$(find drone_frame_description)/meshes/${mesh_file}.stl" scale="0.001 0.001 0.001"/>
      </geometry>
      <material name="red"/>
    </visual>
    <collision>
      <origin xyz="${vco}" rpy="0 0 0"/>
      <geometry>
        <mesh filename="file://$(find drone_frame_description)/meshes/${mesh_file}.stl" scale="0.001 0.001 0.001"/>
      </geometry>
    </collision>
  </link>

  <gazebo reference="thruster_joint_${prop_num}">
    <sensor name="thruster_force_torque_${prop_num}" type="force_torque">
      <always_on>true</always_on>
      <update_rate>100</update_rate>
      <topic>thruster_${prop_num}_ft</topic>
      <visualize>true</visualize>
      <force_torque>
        <frame>child</frame>
        <measure_direction>child_to_parent</measure_direction>
      </force_torque>
    </sensor>
  </gazebo>

</xacro:macro>

<xacro:thruster prop_num="1" vco="0.2 0.026 -0.2" mesh_file="prop_1_1"/>
<xacro:thruster prop_num="2" vco="0.2 0.026 0.2" mesh_file="prop_2_1"/>
<xacro:thruster prop_num="3" vco="-0.2 0.026 -0.2" mesh_file="prop_3_1"/>
<xacro:thruster prop_num="4" vco="-0.2 0.026 0.2" mesh_file="prop_4_1"/>
<xacro:thruster prop_num="5" vco="-0.2 -0.066 0.2" mesh_file="prop_5_1"/>
<xacro:thruster prop_num="6" vco="0.2 -0.066 0.2" mesh_file="prop_6_1"/>
<xacro:thruster prop_num="7" vco="0.2 -0.066 -0.2" mesh_file="prop_7_1"/>
<xacro:thruster prop_num="8" vco="-0.2 -0.066 -0.2" mesh_file="prop_8_1"/>

<xacro:macro name="thruster_joint" params="prop_num parent_link child_link axis y">
  <joint name="thruster_joint_${prop_num}" type="continuous">
    <origin xyz="0.0 ${y}  0.0" rpy="0 0 0"/>
    <parent link="${parent_link}"/>
    <child link="${child_link}"/>
    <axis xyz="${axis}"/>
  </joint>
</xacro:macro>

<xacro:thruster_joint prop_num="8" parent_link="motor_8" child_link="thruster_8" axis="0.0 -1.0 0.0" y="0.026"/>
<xacro:thruster_joint prop_num="7" parent_link="motor_5" child_link="thruster_7" axis="-0.0 -1.0 0.0" y="0.026"/>
<xacro:thruster_joint prop_num="6" parent_link="motor_6" child_link="thruster_6" axis="0.0 -1.0 0.0" y="0.026"/>
<xacro:thruster_joint prop_num="5" parent_link="motor_7" child_link="thruster_5" axis="0.0 -1.0 -0.0" y="0.026"/>
<xacro:thruster_joint prop_num="4" parent_link="motor_4" child_link="thruster_4" axis="-0.0 1.0 -0.0" y="-0.026"/>
<xacro:thruster_joint prop_num="3" parent_link="motor_1" child_link="thruster_3" axis="0.0 1.0 -0.0" y="-0.026"/>
<xacro:thruster_joint prop_num="2" parent_link="motor_3" child_link="thruster_2" axis="-0.0 1.0 -0.0" y="-0.026"/>
<xacro:thruster_joint prop_num="1" parent_link="motor_2" child_link="thruster_1" axis="0.0 1.0 0.0" y="-0.026"/>

<xacro:macro name="thruster_plugin" params="prop_num direction">
  <gazebo>
    <plugin filename="ignition-gazebo-multicopter-motor-model-system"
      name="gz::sim::systems::MulticopterMotorModel">
      <robotNamespace>drone_frame</robotNamespace>
      <jointName>thruster_joint_${prop_num}</jointName>
      <linkName>thruster_${prop_num}</linkName>
      <turningDirection>${direction}</turningDirection>
      <timeConstantUp>0.0125</timeConstantUp>
      <timeConstantDown>0.025</timeConstantDown>
      <maxRotVelocity>8000.0</maxRotVelocity>
      <motorConstant>8.54858e-05</motorConstant>
      <momentConstant>0.06</momentConstant>
      <commandSubTopic>rotors/command/motor_speed</commandSubTopic>
      <motorNumber>${prop_num - 1}</motorNumber>
      <rotorDragCoefficient>2.5e-04</rotorDragCoefficient>
      <rollingMomentCoefficient>1e-06</rollingMomentCoefficient>
      <motorSpeedPubTopic>thruster_${prop_num}/cmd</motorSpeedPubTopic>
      <rotorVelocitySlowdownSim>10</rotorVelocitySlowdownSim>
      <motorType>velocity</motorType>
    </plugin>
  </gazebo>
</xacro:macro>

<xacro:thruster_plugin prop_num="1" direction="cw"/>
<xacro:thruster_plugin prop_num="2" direction="ccw"/>
<xacro:thruster_plugin prop_num="3" direction="ccw"/>
<xacro:thruster_plugin prop_num="4" direction="cw"/>
<xacro:thruster_plugin prop_num="5" direction="ccw"/>
<xacro:thruster_plugin prop_num="6" direction="cw"/>
<xacro:thruster_plugin prop_num="7" direction="ccw"/>
<xacro:thruster_plugin prop_num="8" direction="cw"/>

</robot>